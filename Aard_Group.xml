<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Wednesday, December 16, 2015, 5:55 PM -->
<!-- MuClient version 4.96 -->

<!-- Plugin "Aard_Group" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Aard_Group"
   author="Endymion"
   id="af400d0e68fe61ed04b77f75"
   language="Lua"
   purpose="Group features"
   date_written="2015-12-16 17:54:22"
   requires="4.30"
   version="1.0"
   save_state="y"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
  <trigger
   enabled="n"
   match="^[\w\-\.\]\] ]+ is (already|now) fully healed\.$|^[\w\.\- ]+ (is already|now feels) fully refreshed\.$|^You are (now|already) fully (healed|refreshed)\.$"
   omit_from_output="y"
   regexp="y"
   sequence="100"
   name="spam_trigger"
  >
  </trigger>
  <trigger
   enabled="y"
   match="^(?<who>.+) has invited you to join group: (.+)\.$"
   omit_from_output="n"
   regexp="y"
   sequence="100"
   script="group_invite"
  >
  </trigger>
</triggers>

<!--  Aliases  -->

<aliases>
  <alias
   enabled="y"
   match="^grp( (?<chan>(tell )?\w+))?$"
   regexp="y"
   script="report_group"
   sequence="100"
  >
  </alias>
  <alias
   enabled="y"
   match="^grp help$"
   regexp="y"
   script="show_help"
   sequence="99"
  >
  </alias>
  <alias
   enabled="y"
   match="^grp heal spam$"
   regexp="y"
   script="toggle_spam"
   sequence="99"
  >
  </alias>
</aliases>

<!--  Script  -->


<script>
<![CDATA[
require "tprint"

local spam = GetVariable("spam") or "ON"
players_group = {}
local chan
local report = false
local offer = ""

function toggle_spam()
	if spam == "ON" then
		spam = "OFF"
	else
		spam = "ON"
	end
	ColourNote("silver", "", "  Group heal/refresh spam is now ", "white", "", spam, "silver", "", ".")
	SetVariable("spam", spam)
	SaveState()
	update_spam_trigger()
end

function update_spam_trigger()
	if spam == "ON" then
		EnableTrigger("spam_trigger", false)
	else
		EnableTrigger("spam_trigger", true)
	end
end

function group_invite(name, line, args)
	Note("")
	ColourNote("cyan", "", args.who, "white", "", " has invited you to group.  Type ", "cyan", "", "grp", "white", "", " to accept.")
	Note("")
	offer = "group accept "..args.who
end

function report_group(name, line, args)
	chan = "gtell"
	if trim(args.chan) ~= "" then
		chan = trim(args.chan)
	end
	report = true
	CallPlugin("3e7dedbe37e44942dd46d264", "Send_GMCP_Packet", "request group")
end

function report_players()
	if not players_group then
		if offer ~= "" then
			SendNoEcho(offer)
			return
		end
		ColourNote("white", "", "  You are not in a group!")
		return
	end
	local not_here = {}
	for _, p in ipairs(players_group) do
		if p.info.here == "0" then
			table.insert(not_here, p.name)
		end
	end
	local msg = ""
	local cnt
	if table.getn(not_here) == 0 then
		msg = "@CAll groupies present and accounted for!"
	else
		cnt = table.getn(not_here)
		msg = "@W"..cnt.." @x250groupie"
		if cnt ~= 1 then
			msg = msg.."s"
		end
		msg = msg.." not here: "
		for i, p in ipairs(not_here) do
			msg = msg.."@W"..p
			if i < table.getn(not_here) then
				msg = msg.."@Y, "
			end
		end
	end
	if chan == "say" or string.sub(chan, 1, 4) == "tell" then
		SendNoEcho(chan.." "..msg)
	elseif chan == "emote" then
		SendNoEcho(chan.." reports: "..msg)
	else
		SendNoEcho(chan.." :reports: "..msg)
	end
end

function trim(str)
	return (str:gsub("^%s*(.-)%s*$", "%1"))
end

function OnPluginBroadcast (msg, id, name, text)
	if (id == '3e7dedbe37e44942dd46d264') then
		if text == "group" then
			any, pvar = CallPlugin("3e7dedbe37e44942dd46d264", "gmcpval", "group")
			local grp = loadstring("return "..pvar)()
			players_group = grp.members
			if report == true then
				report_players()
				report = false
			end
		end
	end
end

function show_help()
	Note("")
	for i = 1, 40 do
		ColourTell("white", "", "-", "cornflowerblue", "", "-")
	end
	Tell("\n")
	ColourNote("white", "", "   Aard Group Reporter")
	for i = 1, 40 do
		ColourTell("white", "", "-", "cornflowerblue", "", "-")
	end
	Note("")
	ColourTell("white", "", "  grp                            ")
	ColourNote("silver", "", "Will accept an invitation if not in a group.\n                                   Otherwise reports group status to gtell.\n")
	ColourTell("white", "", "  grp <tell/channel>             ")
	ColourNote("silver", "", "Report group status.\n")
	ColourTell("white", "", "  grp heal spam                  ")
	ColourNote("silver", "", "Toggles fully healed/refreshed messages.\n")
	ColourTell("white", "", "  grp help                       ")
	ColourNote("silver", "", "Shows this help file.")
	for i = 1, 40 do
		ColourTell("white", "", "-", "cornflowerblue", "", "-")
	end
	Note("\n")
end

update_spam_trigger()
ColourNote("white", "", "  Aard Group Plugin Loaded!  Submit ", "cyan", "", "grp help", "white", "", " to see the help file.")

]]>
</script>


</muclient>
